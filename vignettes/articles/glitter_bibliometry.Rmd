---
title: "glitter for HAL (en fran√ßais)"
author: "Lise Vaudor"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{glitter for HAL}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This article deals with queries on the [HAL](https://hal.science/) (for "Hyper Article en Ligne") triplestore, [dataHAL](https://data.hal.science/). **HAL** is the **bibliograpic open archive** chosen by French research institutions, universities, and grandes √©coles. Hence, we suppose this article will only be useful to French-speaking R users and will provide it **in French** from now on...

Les donn√©es contenues dans le triplestore HAL sont a priori utilisables pour g√©n√©rer des **rapports bibliographiques** pour une **personne**, une **organisation** (UMR par exemple), en triant par exemple par **ann√©e** ou par **p√©riode**.

On peut ainsi imaginer utiliser ces donn√©es pour **g√©n√©rer automatiquement et de mani√®re reproductible** un certain nombre de **tables ou graphiques** en lien avec les **√©valuations** du personnel publiant des √©tablissements de recherche.

Dans la suite de cet article je montrerai comment explorer et exploiter ces donn√©es √† l'aide de R, et (notamment) du paquet glitter (pour cr√©er et r√©aliser les requ√™tes) et du paquet [sequins](https://lvaudor.github.io/sequins/) (pour visualiser les requ√™tes).

```{r libs, message=FALSE}
library(glitter)
library(sequins)
library(dplyr)
library(tidyr)
```


# Entr√©e par auteur¬∑rice

Essayons par exemple d'examiner s'il existe dans la base quelqu'un qui s'appelle (tout √† fait au hasard) "Lise Vaudor":

```{r test_LV}
test_LV=spq_init("hal") %>% 
  spq_add("?personne foaf:name 'Lise Vaudor'")  %>%  # r√©cup√®re les personnes appel√©es "Lise Vaudor"
  spq_perform()
DT::datatable(test_LV)
```

Il existe bien une personne ayant ce nom dans la base de donn√©es, qui fait l'objet d'une [fiche consultable](`r test_LV$personne[1]`).

La consultation de cette page montre que deux propri√©t√©s sont souvent renseign√©es: **foaf:interest** et **foaf:topic_interest**. Cette derni√®re propri√©t√© semble regrouper des mots-cl√©s issus de l'ensemble des publications de l'auteur alors que foaf:interest correspond √† des centres d'int√©r√™t d√©clar√©s (probablement lors de la cr√©ation du profil HAL: √† vrai dire je ne m'en souviens plus!).

Quoi qu'il en soit, l'information relative aux centres d'int√©r√™t est accessible comme suit:

```{r interet_LV, fig.width=7,fig.height=7}
requete = spq_init("hal") %>%
  spq_add("?personne foaf:name 'Lise Vaudor'")  %>%
  spq_add("?personne foaf:interest ?interet") %>%        # r√©cup√®re les centres d'int√©r√™t
  spq_add("?interet skos:prefLabel ?interet_label") %>%  # √©tiquette les centres d'int√©r√™t
  spq_filter(lang(interet_label) == 'fr')

sequins::graph_query(requete, layout = "tree")
```


```{r interet_LV_run}
interet_LV = requete %>%               # garde seulement les √©tiquettes en fran√ßais
  spq_perform()
DT::datatable(interet_LV)
```

# Documents d'un¬∑e auteur¬∑rice

Une des petites subtilit√©s du mod√®le de donn√©es HAL consiste √† consid√©rer que **un document a un cr√©ateur¬∑rice -- ou auteur¬∑rice -- et un¬∑e cr√©ateur¬∑rice correspond √† une personne**.

## Affiliations

Par exemple, l'article "How sampling influences the statistical power to detect changes in abundance: an application to river restoration" a pour cr√©atrice (entre autres personnes) "Lise Vaudor √† l'√©poque du Cemagref", qui correspond √† la personne "Lise Vaudor" qui elle est intemporelle üòâ.

Ainsi, c'est en consid√©rant les cr√©ateurs de documents que l'on va r√©cup√©rer les affiliations: **l'affiliation est une information qui se r√©cup√®re en adoptant une entr√©e par document plut√¥t que par auteur¬∑rice**.


```{r orga_LV_prep, fig.width=7, fig.height=8}
requete = spq_init("hal") %>%
  spq_add("?doc dcterms:creator ?createur") %>%        # documents cr√©es par cr√©ateur
  spq_add("?createur hal:structure ?affil") %>%        # cr√©ateur correspond √† une affiliation
  spq_add("?createur hal:person ?personne") %>%        # cr√©ateur correspond √† une personne
  spq_add("?personne foaf:name 'Lise Vaudor'") %>%     
  spq_add("?affil skos:prefLabel ?affiliation") %>%    # √©tiquette affiliation
  spq_group_by(affiliation) %>%                        # groupe par affiliation
  spq_summarise(n = n()) %>% 
  spq_arrange(desc(n))

requete

sequins::graph_query(requete, layout="tree")
```

```{r orga_LV_run}
orga_LV = requete %>%                             # renvoie le nombre d'enregistrements
  spq_perform()

DT::datatable(orga_LV) 
```

## Documents 

Si l'on ne s'int√©resse pas aux affiliations mais aux **documents** eux-m√™mes:

```{r docs_LV}
docs_LV = spq_init(endpoint = "hal") %>%
  spq_add("?doc dcterms:creator ?createur") %>%
  spq_add("?createur hal:structure ?affil") %>%
  spq_add("?createur hal:person ?personne") %>%
  spq_add("?personne foaf:name 'Lise Vaudor'") %>%
  spq_add("?affil skos:prefLabel ?affiliation") %>%
  spq_add("?doc dcterms:type ?type") %>% 
  spq_add("?type skos:prefLabel ?type_label") %>%
  spq_filter(lang(type_label) == 'fr') %>% 
  spq_add("?doc dcterms:bibliographicCitation ?citation") %>%
  spq_add("?doc dcterms:issued ?date") %>%
  spq_mutate(date = str_sub(as.character(date), 1, 4)) %>%
  spq_group_by(citation, type_label, date) %>%
  spq_summarise(affiliation = str_c(affiliation, sep = ", ")) %>%
  spq_perform()

docs_LV
```

Cette requ√™te renvoie une table comptant `r nrow(docs_LV)`. Voici les 20 documents les plus r√©cents:

```{r docs_LV_recents}
docs_LV %>%
  arrange(desc(date)) %>%
  head(20) %>% 
  DT::datatable() 
```


# Entr√©e par laboratoire


## Identification du laboratoire

Int√©ressons-nous maintenant aux **publications issues d'un laboratoire**. Ici, nous avons choisi le laboratoire "Environnement Ville Soci√©t√©", alias "EVS" ou encore "UMR 5600".

Essayons de le retrouver dans la base de donn√©es:

```{r labo_EVS}
labo_EVS = spq_init(endpoint = "hal") %>%      
    spq_add("?labo skos:prefLabel ?labo_label") %>%
    spq_add("?labo dcterms:identifier ?labo_id", .required = FALSE) %>% 
    spq_filter(str_detect(labo_label,"EVS|(UMR 5600)|(Environnement Ville Soc)")) %>%
    spq_perform()
labo_EVS
```

Bon! Eh bien, √©tant donn√© la diversit√© des formats dans la d√©nomination d'EVS, un petit tri manuel s'impose.

```{r labo_EVS_filter}
labo_EVS = labo_EVS %>% 
  unique() %>% 
  mutate(num = 1:n()) %>% 
  filter(!(num %in% c(1,2,3,18))) %>%  # ici je retire les labos qui ne correspondent pas √† UMR 5600 / EVS
  select(-num)
DT::datatable(labo_EVS)
```

Cr√©ons maintenant une fonction qui permet de r√©cup√©rer l'**ensemble des documents pour chacune de ces d√©nominations de laboratoire**.

```{r get_docs_lab}
get_docs_lab = function(lab){
  lab = paste0("<",lab,">")
  result = spq_init(endpoint = "hal") %>%      
    spq_add(glue::glue("?createur hal:structure {lab}")) %>% 
    spq_add("?createur hal:person ?personne") %>%
    spq_add("?personne foaf:name ?auteur") %>%
    spq_add("?doc dcterms:creator ?createur") %>% 
    spq_select(-createur) %>%
    spq_add("?doc dcterms:type ?type") %>%            # r√©cup√®re le type de document
    spq_add("?type skos:prefLabel ?type_label") %>%   # √©tiquette le type de document
    spq_filter(lang(type_label) == 'fr') %>%          # ... en fran√ßais
    spq_add("?doc dcterms:bibliographicCitation ?citation") %>% # r√©cup√®re la citation
    spq_add("?doc dcterms:issued ?date") %>%
    spq_perform() %>%
    mutate(date = stringr::str_sub(date,1,4))  %>% 
    select(auteur, type = type_label, date, citation)
  return(result)
}
```

Appliquons maintenant cette fonction √† chacune des d√©nominations possibles pour le labo EVS:

```{r apply_get_docs_lab}
docs_EVS = labo_EVS %>% 
    group_by(labo, labo_label) %>%
    tidyr::nest() %>% 
    mutate(data = purrr::map(labo, get_docs_lab)) %>% 
    tidyr::unnest(cols="data") 

dim(docs_EVS)
```

Cette table compte de nombreux enregistrements (`r nrow(docs_EVS)`). On montre ci-dessous les plus r√©cents (√† partir de 2020):

```{r docs_EVS_show}
docs_EVS_show = docs_EVS %>% 
  select(-labo) %>%
  filter(date >= 2020) %>% 
  unique() %>% 
  select(auteur, date, type, citation, citation) %>% 
  ungroup()
  
dim(docs_EVS_show)  

DT::datatable(docs_EVS_show) 
```

# Rendus graphiques

On peut d√®s lors utiliser ces donn√©es pour produire un **certain nombre de graphiques** permettant d'appr√©cier la production du laboratoire au cours du temps:

```{r plot_datecitation}
docs_datecitation = docs_EVS %>%
  group_by(type) %>% 
  mutate(ntype = n()) %>% 
  ungroup() %>% 
  mutate(ntot = n()) %>%
  mutate(proptype = ntype/ntot) %>% 
  filter(proptype > 0.05) %>% 
  group_by(date, citation, type) %>%
  summarise(n = n()) %>% 
  filter(date > 2015)

ggplot(docs_datecitation, aes(x = date, y = n, fill = type)) +
  geom_bar(stat = "identity") +
  facet_grid(rows = vars(type))
```

Il ne s'agit l√† que d'un exemple (parmi beaucoup d'autres possibilit√©s comme l'exploitation de mots cl√©s, de statistiques par journal, de r√©seaux d'auteurs) pour exploiter ces donn√©es. Nanmoins ces m√©thodes allant au-del√† du "scope" du package glitter nous n'irons pas plus loin en terme d'analyse des r√©sultats des requ√™tes dans ce document.

